# Yocto Layer Configuration for Toyota Multimedia System
# Layer: meta-toyota-multimedia
# Compatible with Yocto Kirkstone (4.0)

SUMMARY = "Toyota Corolla 2026 Multimedia System Layer"
DESCRIPTION = "This layer provides the multimedia infotainment system for 2026 Corolla"

# Layer configuration
BBPATH .= ":${LAYERDIR}"
BBFILES += "${LAYERDIR}/recipes-*/*/*.bb ${LAYERDIR}/recipes-*/*/*.bbappend"

BBFILE_COLLECTIONS += "meta-toyota-multimedia"
BBFILE_PATTERN_meta-toyota-multimedia := "^${LAYERDIR}/"
BBFILE_PRIORITY_meta-toyota-multimedia = "10"

# Layer dependencies
LAYERDEPENDS_meta-toyota-multimedia = "core"
LAYERSERIES_COMPAT_meta-toyota-multimedia = "kirkstone"

# Required layers
LAYERDEPENDS_meta-toyota-multimedia += "\
    meta-qt6 \
    meta-automotive \
    meta-security \
    meta-networking \
    "

# Machine configuration
MACHINE ?= "corolla-2026-ecu"

# Distro features
DISTRO_FEATURES:append = " \
    bluetooth \
    wifi \
    wayland \
    pulseaudio \
    opengl \
    systemd \
    usrmerge \
    seccomp \
    "

# Package management
PACKAGE_CLASSES ?= "package_deb"

# Image features
IMAGE_INSTALL:append = " \
    toyota-multimedia-core \
    toyota-multimedia-hmi \
    toyota-connectivity \
    toyota-navigation \
    toyota-media-player \
    toyota-ota-client \
    toyota-vehicle-interface \
    carplay-integration \
    androidauto-integration \
    "

# Qt configuration
QT_VERSION = "6.5.3"
PACKAGECONFIG:pn-qtbase = "\
    accessibility \
    dbus \
    egl \
    eglfs \
    evdev \
    fontconfig \
    glib \
    icu \
    kms \
    libinput \
    mtdev \
    opengl \
    wayland \
    "

# Security features
EXTRA_IMAGE_FEATURES += " \
    read-only-rootfs \
    dm-verity \
    "

# Secure boot
INHERIT += "sign_rpm sign_package_feed"
RPM_SIGN_PACKAGES = "1"

# OTA update support
IMAGE_FSTYPES:append = " wic.gz wic.bmap"
WKS_FILE = "toyota-ota-ab.wks"

# A/B partition scheme for OTA
TOYOTA_AB_PARTITIONS = "1"
TOYOTA_ROOTFS_A = "/dev/mmcblk0p2"
TOYOTA_ROOTFS_B = "/dev/mmcblk0p3"

# Kernel configuration
PREFERRED_PROVIDER_virtual/kernel = "linux-toyota"
KERNEL_VERSION = "6.1"
KERNEL_FEATURES:append = " \
    cfg/systemd \
    features/can \
    features/automotive \
    "

# Bootloader
PREFERRED_PROVIDER_virtual/bootloader = "u-boot-toyota"
UBOOT_MACHINE = "corolla_2026_defconfig"

# Filesystem
IMAGE_ROOTFS_EXTRA_SPACE = "2097152"
IMAGE_OVERHEAD_FACTOR = "1.3"

# Multimedia codecs
LICENSE_FLAGS_ACCEPTED = "commercial"
PACKAGECONFIG:pn-gstreamer1.0-plugins-ugly = "x264"
PACKAGECONFIG:pn-gstreamer1.0-plugins-bad = "faac faad"

# Development tools (remove in production)
EXTRA_IMAGE_FEATURES += "debug-tweaks tools-debug tools-profile ssh-server-openssh"

# Time zone
DEFAULT_TIMEZONE = "America/Los_Angeles"

# Locales
IMAGE_LINGUAS = "en-us es-us fr-ca"

# Network configuration
CONNECTIVITY_CHECK_URIS = "https://www.toyota.com"

# Systemd configuration
VIRTUAL-RUNTIME_init_manager = "systemd"
VIRTUAL-RUNTIME_initscripts = "systemd-compat-units"
DISTRO_FEATURES_BACKFILL_CONSIDERED = "sysvinit"

# Toyota-specific configurations
TOYOTA_VEHICLE_TYPE = "corolla"
TOYOTA_MODEL_YEAR = "2026"
TOYOTA_REGION = "north-america"
TOYOTA_ECU_VARIANT = "premium"

# Feature flags
TOYOTA_FEATURES = "\
    navigation-cloud \
    voice-assistant \
    remote-services \
    wifi-hotspot \
    wireless-carplay \
    wireless-android-auto \
    "

# Build optimizations
BB_NUMBER_THREADS ?= "${@oe.utils.cpu_count()}"
PARALLEL_MAKE ?= "-j ${@oe.utils.cpu_count()}"

# SDK generation
SDKMACHINE ?= "x86_64"
